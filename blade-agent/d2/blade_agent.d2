# blade-agent.sh — Big Loop Orchestrator
# Reads goal.md → selects lane → runs Ralph → verifies → iterates

classes: {
  entrypoint: {
    style.fill: "#2980b9"
    style.font-color: "#ffffff"
    style.stroke: "#1a5276"
    style.stroke-width: 3
    style.bold: true
    style.shadow: true
    style.border-radius: 8
  }
  function: {
    style.fill: "#d6eaf8"
    style.stroke: "#2980b9"
    style.stroke-width: 1
    style.border-radius: 5
  }
  external-call: {
    style.fill: "#fef9e7"
    style.stroke: "#f39c12"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
  data-store: {
    style.fill: "#d5f5e3"
    style.stroke: "#27ae60"
    style.stroke-width: 2
    style.border-radius: 3
  }
  utility: {
    style.fill: "#f2f3f4"
    style.stroke: "#95a5a6"
    style.stroke-width: 1
    style.border-radius: 5
  }
  error-path: {
    style.fill: "#fdedec"
    style.stroke: "#e74c3c"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
  decision: {
    shape: diamond
    style.fill: "#fdebd0"
    style.stroke: "#e67e22"
    style.stroke-width: 2
  }
}

direction: down

# ── Entry & Init ──
main: "blade-agent.sh" { class: entrypoint }
goal_file: "goal.md" { class: data-store; shape: page }
state_file: "state.json" { class: data-store; shape: page }

main -> goal_file: reads
main -> parse_args: 1. parse CLI

parse_args: "parse args\n--goal --max --resume --dry-run" { class: function }
parse_args -> parse_lane: extract LANE
parse_args -> parse_topic: extract TOPIC

parse_lane: "parse_lane()" { class: function }
parse_topic: "parse_topic()" { class: function }

# ── Feature Flags ──
feature_check: "Feature flags?" { class: decision }
parse_args -> feature_check: 2. check flags

feature_check -> load_tools: "SAFE_TOOLS=true" {
  style.stroke: "#95a5a6"
  style.stroke-dash: 5
}
feature_check -> load_refinement: "REFINEMENT=true" {
  style.stroke: "#95a5a6"
  style.stroke-dash: 5
}

load_tools: "source tools.sh" { class: utility }
load_refinement: "source refinement.sh" { class: utility }

# ── State Recovery ──
feature_check -> resume_check: 3. state recovery
resume_check: "Resume?" { class: decision }
resume_check -> state_init: "no" { style.stroke: "#27ae60" }
resume_check -> state_recover: "yes"

state_init: "state_init()" { class: function }
state_init -> state_file: writes

state_recover: "Recover from\nlast iteration" { class: function }
state_recover -> state_file: reads

# ── Big Loop ──
big_loop: "Big Loop (1..MAX_ITERATIONS)" {
  style.fill: "#eaf2f8"
  style.stroke: "#2980b9"
  style.stroke-width: 2
  style.border-radius: 10

  direction: down

  lane_dispatch: "Lane?" { class: decision }

  # Engineer Lane
  run_engineer: "run_engineer()" { class: function }
  lane_dispatch -> run_engineer: engineer

  # Scientist Lane
  run_scientist: "run_scientist()" { class: function }
  lane_dispatch -> run_scientist: scientist

  # Student Lane
  run_student: "run_student()" { class: function }
  lane_dispatch -> run_student: student

  # Goal Check
  goal_check: "goal_check.sh" { class: external-call }
  run_engineer -> goal_check: verify
  run_scientist -> goal_check: verify
  run_student -> goal_check: verify

  goal_pass: "All CHECKs pass?" { class: decision }
  goal_check -> goal_pass

  done: "Exit 0 (success)" {
    class: entrypoint
    style.fill: "#27ae60"
  }
  goal_pass -> done: "yes" { style.stroke: "#27ae60" }

  retry: "Retry\n(next iteration)" { class: error-path }
  goal_pass -> retry: "no" {
    style.stroke: "#e74c3c"
    style.stroke-dash: 3
  }
}

resume_check -> big_loop: 4. enter loop
state_init -> big_loop

# ── Notifications ──
notify_start: "notify(started)" { class: external-call }
main -> notify_start

notify_done: "notify(DONE)" { class: external-call }
big_loop -> notify_done: on success

# ── Circuit Breaker ──
circuit_breaker: "Max iterations\nreached (exit 1)" { class: error-path }
big_loop -> circuit_breaker: exhausted
