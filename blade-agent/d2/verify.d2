# verify/ — Verification Scripts
# engineer_ok.sh, scientist_ok.sh, goal_check.sh

classes: {
  entrypoint: {
    style.fill: "#2980b9"
    style.font-color: "#ffffff"
    style.stroke: "#1a5276"
    style.stroke-width: 3
    style.bold: true
    style.shadow: true
    style.border-radius: 8
  }
  function: {
    style.fill: "#d6eaf8"
    style.stroke: "#2980b9"
    style.stroke-width: 1
    style.border-radius: 5
  }
  data-store: {
    style.fill: "#d5f5e3"
    style.stroke: "#27ae60"
    style.stroke-width: 2
    style.border-radius: 3
  }
  utility: {
    style.fill: "#f2f3f4"
    style.stroke: "#95a5a6"
    style.stroke-width: 1
    style.border-radius: 5
  }
  error-path: {
    style.fill: "#fdedec"
    style.stroke: "#e74c3c"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
  decision: {
    shape: diamond
    style.fill: "#fdebd0"
    style.stroke: "#e67e22"
    style.stroke-width: 2
  }
}

direction: down

# ══ goal_check.sh ══
goal_check: "verify/goal_check.sh" {
  style.fill: "#eaf2f8"
  style.stroke: "#2980b9"
  style.border-radius: 8
  style.bold: true
  direction: down

  goal_file_gc: "goal.md" { class: data-store; shape: page }
  parse_checks: "grep CHECK: lines" { class: function }
  goal_file_gc -> parse_checks: reads

  eval_loop: "For each CHECK cmd" {
    style.fill: "#f2f3f4"
    style.stroke: "#bdc3c7"
    style.border-radius: 5

    eval_cmd: "eval cmd" { class: function }
    pass: "PASS" { class: utility }
    fail: "FAIL" { class: error-path }
    eval_cmd -> pass: "exit 0" { style.stroke: "#27ae60" }
    eval_cmd -> fail: "exit != 0" { style.stroke: "#e74c3c" }
  }
  parse_checks -> eval_loop

  all_pass: "All passed?" { class: decision }
  eval_loop -> all_pass
}

# ══ engineer_ok.sh ══
engineer_ok: "verify/engineer_ok.sh" {
  style.fill: "#fef9e7"
  style.stroke: "#f39c12"
  style.border-radius: 8
  style.bold: true
  direction: down

  fix_plan: "fix_plan.md" { class: data-store; shape: page }
  detect_format: "Detect format" { class: decision }
  fix_plan -> detect_format

  format_a: "Format A\n- [ ] / - [x]" { class: function }
  format_b: "Format B\n### Task N [DONE]" { class: function }
  detect_format -> format_a: checkboxes
  detect_format -> format_b: headings

  count: "Count done vs total" { class: utility }
  format_a -> count
  format_b -> count

  all_done: "All tasks done?" { class: decision }
  count -> all_done
}

# ══ scientist_ok.sh ══
scientist_ok: "verify/scientist_ok.sh" {
  style.fill: "#d5f5e3"
  style.stroke: "#27ae60"
  style.border-radius: 8
  style.bold: true
  direction: down

  exp_dir: "experiments/TOPIC/" { class: data-store }

  checks: "7-Step Checks" {
    style.fill: "#f2f3f4"
    style.stroke: "#bdc3c7"
    style.border-radius: 5
    direction: down

    s1: "Session file exists" { class: utility }
    s2: "Hub + hypothesis tree" { class: utility }
    s3: "Roadmap + MVP + Gate" { class: utility }
    s4: "Experiment report" { class: utility }
    s5: "Gate decision" { class: utility }
    s6: "Knowledge card" { class: utility }
    s7: "Skills directory" { class: utility }

    s1 -> s2 -> s3 -> s4 -> s5 -> s6 -> s7
  }

  exp_dir -> checks: verify artifacts

  result: "All checks pass?" { class: decision }
  checks -> result
}
