# lib/claude_coder.sh — Claude Code CLI Execution Backend
# Drop-in replacement for Aider with model escalation

classes: {
  entrypoint: {
    style.fill: "#2980b9"
    style.font-color: "#ffffff"
    style.stroke: "#1a5276"
    style.stroke-width: 3
    style.bold: true
    style.shadow: true
    style.border-radius: 8
  }
  function: {
    style.fill: "#d6eaf8"
    style.stroke: "#2980b9"
    style.stroke-width: 1
    style.border-radius: 5
  }
  external-call: {
    style.fill: "#fef9e7"
    style.stroke: "#f39c12"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
  data-store: {
    style.fill: "#d5f5e3"
    style.stroke: "#27ae60"
    style.stroke-width: 2
    style.border-radius: 3
  }
  utility: {
    style.fill: "#f2f3f4"
    style.stroke: "#95a5a6"
    style.stroke-width: 1
    style.border-radius: 5
  }
  error-path: {
    style.fill: "#fdedec"
    style.stroke: "#e74c3c"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
  decision: {
    shape: diamond
    style.fill: "#fdebd0"
    style.stroke: "#e67e22"
    style.stroke-width: 2
  }
}

direction: down

# ── Entry ──
claude_execute_plan: "claude_execute_plan()" { class: entrypoint }
fix_plan: "fix_plan.md" { class: data-store; shape: page }
claude_execute_plan -> fix_plan: reads

# ── Shared utilities (from aider.sh) ──
shared: "Shared with aider.sh" {
  style.fill: "#f2f3f4"
  style.stroke: "#bdc3c7"
  style.border-radius: 8
  direction: right

  parse_tasks: "_parse_unchecked_tasks()" { class: utility }
  mark_done: "_mark_task_done()" { class: utility }
  validate: "_validate_edited_files()" { class: utility }
  revert: "_revert_last_commit()" { class: utility }
}

claude_execute_plan -> shared.parse_tasks: extract tasks

# ── Task Execution ──
task_loop: "For each unchecked task" {
  style.fill: "#eaf2f8"
  style.stroke: "#2980b9"
  style.stroke-width: 2
  style.border-radius: 10
  direction: down

  build_prompt: "_claude_build_prompt()" { class: function }
  run_task: "_claude_run_task()" { class: function }
  build_prompt -> run_task

  claude_cli: "claude -p <prompt>\n--model sonnet\n--permission-mode bypassPermissions" { class: external-call }
  run_task -> claude_cli: exec

  task_ok: "Task succeeded?" { class: decision }
  claude_cli -> task_ok

  escalate: "_claude_escalate()" { class: error-path }
  task_ok -> escalate: "no" {
    style.stroke: "#e74c3c"
    style.stroke-dash: 3
  }

  claude_cli_opus: "claude -p <prompt>\n--model opus\n(fallback)" { class: external-call }
  escalate -> claude_cli_opus: retry stronger model

  done: "Mark done" { class: function }
  task_ok -> done: "yes" { style.stroke: "#27ae60" }
  claude_cli_opus -> done: "if succeeds" { style.stroke: "#27ae60" }
}

shared.parse_tasks -> task_loop: iterate
task_loop -> shared.validate: check files
shared.validate -> shared.mark_done: "valid" { style.stroke: "#27ae60" }
shared.validate -> shared.revert: "corrupt" {
  style.stroke: "#e74c3c"
  style.stroke-dash: 3
}

# ── Summary ──
summary: "Summary:\ncompleted / failed / escalated" { class: utility }
task_loop -> summary
