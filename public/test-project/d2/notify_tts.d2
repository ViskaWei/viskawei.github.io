# External Integrations: notify.sh + learn_tts.sh
# Telegram notifications and Fish-Speech TTS

classes: {
  entrypoint: {
    style.fill: "#2980b9"
    style.font-color: "#ffffff"
    style.stroke: "#1a5276"
    style.stroke-width: 3
    style.bold: true
    style.shadow: true
    style.border-radius: 8
  }
  function: {
    style.fill: "#d6eaf8"
    style.stroke: "#2980b9"
    style.stroke-width: 1
    style.border-radius: 5
  }
  external-call: {
    style.fill: "#fef9e7"
    style.stroke: "#f39c12"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
  data-store: {
    style.fill: "#d5f5e3"
    style.stroke: "#27ae60"
    style.stroke-width: 2
    style.border-radius: 3
  }
  utility: {
    style.fill: "#f2f3f4"
    style.stroke: "#95a5a6"
    style.stroke-width: 1
    style.border-radius: 5
  }
  decision: {
    shape: diamond
    style.fill: "#fdebd0"
    style.stroke: "#e67e22"
    style.stroke-width: 2
  }
  error-path: {
    style.fill: "#fdedec"
    style.stroke: "#e74c3c"
    style.stroke-width: 2
    style.stroke-dash: 4
    style.border-radius: 5
  }
}

direction: down

# ══ lib/notify.sh ══
notify_module: "lib/notify.sh" {
  style.fill: "#eaf2f8"
  style.stroke: "#2980b9"
  style.border-radius: 8
  style.bold: true
  direction: right

  notify_fn: "notify(msg)" { class: entrypoint }
  env_file: "blade/.env" { class: data-store; shape: page }
  notify_fn -> env_file: reads token + chat_id

  has_config: "Telegram\nconfigured?" { class: decision }
  env_file -> has_config

  telegram_api: "Telegram Bot API\ncurl POST" { class: external-call }
  has_config -> telegram_api: "yes (async &)"

  local_print: "Print locally" { class: utility }
  has_config -> local_print: "no"
}

# ══ lib/learn_tts.sh ══
tts_module: "lib/learn_tts.sh" {
  style.fill: "#d5f5e3"
  style.stroke: "#27ae60"
  style.border-radius: 8
  style.bold: true
  direction: down

  learn_tts_batch: "learn_tts_batch()\ninput_dir, voice_ref" { class: entrypoint }

  md_files: "*.md files\n(input chunks)" { class: data-store }
  voice_ref: "voice reference\n.wav file" { class: data-store }

  learn_tts_batch -> md_files: validates
  learn_tts_batch -> voice_ref: validates

  conda: "conda activate\nfish-speech" { class: external-call }
  learn_tts_batch -> conda: activate env

  batch_tts: "batch_tts.py\n--skip-existing" { class: external-call }
  conda -> batch_tts: run

  audio_dir: "audio/*.wav\n(output)" { class: data-store }
  batch_tts -> audio_dir: generates

  report_count: "Report WAV count" { class: utility }
  audio_dir -> report_count
}
