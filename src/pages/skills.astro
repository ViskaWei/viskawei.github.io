---
import BaseLayout from '../layouts/BaseLayout.astro';
import '../styles/skilltree.css';
import '../styles/techtree.css';

// Load registry data at build time
import registryData from '../data/skills-registry.json';
const { summary, skills } = registryData;

const sourceIcons: Record<string, string> = {
  private: 'lock',
  public: 'public',
  scientific: 'science',
  local: 'terminal',
};

const maturityColors: Record<string, string> = {
  mature: '#4fc3f7',
  growing: '#66bb6a',
  seedling: '#ffd54f',
  empty: '#ef5350',
};
---

<BaseLayout title="Skills Hub â€” Viska Wei" description="Interactive dashboard of Claude Code skills and tooling ecosystem">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />

  <div class="galaxy-page">
    <!-- TOP HUD BAR -->
    <header class="stellaris-top-bar">
      <div class="top-bar-resources">
        <div class="resource-counter" style="--rc-color: #4fc3f7">
          <span class="material-symbols-outlined resource-icon">hub</span>
          <span class="resource-label">TOTAL</span>
          <span class="resource-value">{summary.total}</span>
        </div>
        {Object.entries(summary.by_source).map(([src, count]) => (
          <div class="resource-counter" style={`--rc-color: ${{private:'#26c6da',public:'#66bb6a',scientific:'#ab47bc',local:'#ff7043'}[src] || '#888'}`}>
            <span class="material-symbols-outlined resource-icon">{sourceIcons[src] || 'code'}</span>
            <span class="resource-label">{src.toUpperCase()}</span>
            <span class="resource-value">{count}</span>
          </div>
        ))}
      </div>
      <div class="top-bar-center" style="display:flex;align-items:center;gap:12px">
        <span class="material-symbols-outlined" style="color:#ef3535;font-size:22px">smart_toy</span>
        <span style="color:#ef3535;font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:700;letter-spacing:0.15em">BLADE AGENT</span>
        <a href="/factory" class="factory-link">
          <span class="material-symbols-outlined" style="font-size:16px">precision_manufacturing</span>
          Factory
          <span style="font-size:12px;opacity:0.6">&rarr;</span>
        </a>
      </div>
      <div class="top-bar-controls">
        <div class="resource-counter" style="--rc-color: #4fc3f7">
          <span class="material-symbols-outlined resource-icon">speed</span>
          <span class="resource-label">AVG MATURITY</span>
          <span class="resource-value">{summary.average_maturity_score}</span>
        </div>
        {Object.entries(summary.by_maturity).map(([level, count]) => (
          <div class="resource-counter" style={`--rc-color: ${maturityColors[level] || '#888'}`}>
            <span class="resource-label">{level.toUpperCase()}</span>
            <span class="resource-value">{count}</span>
          </div>
        ))}
      </div>
    </header>

    <!-- MAIN SKILLS CONTAINER -->
    <div class="galaxy-container" id="skills-root">
      <!-- Track filters + SVG tree rendered dynamically by SkillsHub.ts -->

      <!-- Skill detail panel -->
      <div class="galaxy-detail-panel" id="skill-detail" style="right:16px">
        <div class="hud-border">
          <div class="hud-corner tl"></div>
          <div class="hud-corner tr"></div>
          <div class="hud-corner bl"></div>
          <div class="hud-corner br"></div>
        </div>
        <button class="close-btn" aria-label="Close">&times;</button>
        <div class="detail-type-badge" id="detail-source">SOURCE</div>
        <h3 id="detail-name">Skill Name</h3>
        <div class="detail-code" id="detail-id">skill-id</div>
        <div class="detail-meta">
          <span class="detail-institution-badge" id="detail-maturity-level">mature</span>
          <span class="detail-year" id="detail-score">Score: 85</span>
        </div>
        <div class="detail-track" id="detail-desc" style="max-height:120px;overflow-y:auto;font-size:0.8rem;opacity:0.8"></div>
        <div class="detail-prereqs detail-section" id="detail-tags-section" style="display:none">
          <h4>Tags</h4>
          <div class="detail-list" id="detail-tags"></div>
        </div>
        <div class="detail-projects detail-section" id="detail-dod-section" style="display:none">
          <h4>Definition of Done</h4>
          <div class="detail-list" id="detail-dod"></div>
        </div>
        <div class="sg-mastery-section" style="margin-top:0.5rem">
          <div class="sg-mastery-label">MATURITY</div>
          <div class="sg-mastery-bar">
            <div class="sg-mastery-fill" id="detail-maturity-bar" style="width: 0%"></div>
          </div>
        </div>
        <div id="detail-reference-section" style="display:none;margin-top:0.75rem;border-top:1px solid rgba(255,255,255,0.06);padding-top:0.5rem">
          <h4 style="font-size:0.7rem;color:#4fc3f7;margin:0 0 0.4rem;letter-spacing:0.1em">REFERENCE</h4>
          <div id="detail-reference" style="max-height:280px;overflow-y:auto;font-size:0.68rem;line-height:1.5;color:#8b949e"></div>
        </div>
      </div>
    </div>

    <!-- BOTTOM HUD BAR -->
    <footer class="stellaris-bottom-bar">
      <div class="bottom-legend">
        {Object.entries(maturityColors).map(([level, color]) => (
          <div class="legend-item">
            <span style={`display:inline-block;width:10px;height:10px;border-radius:50%;background:${color}`}></span>
            <span>{level}</span>
          </div>
        ))}
      </div>
      <div class="bottom-center">
        <a href="/" class="close-galaxy-btn">
          <span class="close-galaxy-text">Back to Home</span>
        </a>
      </div>
      <div class="bottom-right">
        <div class="map-mode-btns">
          <button class="map-mode-btn" data-filter="all" title="All">
            <span class="material-symbols-outlined">select_all</span>
          </button>
          <button class="map-mode-btn" data-filter="active" title="Active Only">
            <span class="material-symbols-outlined">check_circle</span>
          </button>
          <button class="map-mode-btn" data-filter="mature" title="Mature Only">
            <span class="material-symbols-outlined">star</span>
          </button>
        </div>
        <a href="/background" class="map-mode-btn" title="Skill Galaxy" style="text-decoration:none">
          <span class="material-symbols-outlined">travel_explore</span>
        </a>
      </div>
    </footer>
  </div>
</BaseLayout>

<style>
  /* Override galaxy-container for scrollable tree layout */
  #skills-root {
    overflow: auto !important;
  }
  #skills-root::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  #skills-root::-webkit-scrollbar-track {
    background: rgba(13, 17, 23, 0.5);
  }
  #skills-root::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 4px;
  }
  #skills-root::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.25);
  }
  #skills-root::-webkit-scrollbar-corner {
    background: rgba(13, 17, 23, 0.5);
  }
  .factory-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 6px;
    border: 1px solid rgba(79, 195, 247, 0.3);
    background: rgba(79, 195, 247, 0.08);
    color: #4fc3f7;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  .factory-link:hover {
    background: rgba(79, 195, 247, 0.18);
    border-color: rgba(79, 195, 247, 0.5);
    color: #4fc3f7;
    box-shadow: 0 0 12px rgba(79, 195, 247, 0.15);
  }
</style>

<script>
  import { initSkillsHub } from '../islands/SkillsHub';
  import * as registryModule from '../data/skills-registry.json';

  // Vite exports JSON as named exports; reconstruct the object
  const registryData = {
    summary: registryModule.summary,
    skills: registryModule.skills,
    generated_at: registryModule.generated_at,
    version: registryModule.version,
  };

  const container = document.getElementById('skills-root');
  if (container) {
    initSkillsHub(container, registryData as any);
  }
</script>
